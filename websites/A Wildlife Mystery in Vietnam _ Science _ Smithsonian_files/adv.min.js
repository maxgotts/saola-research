var AdView=Backbone.View.extend({initialize:function(a){a.outOfPage?this.slot=googletag.defineOutOfPageSlot(GPT.path,a.id):this.slot=googletag.defineSlot(GPT.path,a.sizes,a.id),this.el=document.getElementById(a.id),this.$el=$(this.el),this.$el.attr("data-ad-setup","true");var b=googletag.pubads();return this.$el.attr("data-ad-endEvent")&&b.addEventListener("slotRenderEnded",function(a){a.slot===this.slot&&log.info("Slot has been rendered:",this.id,"empty: "+a.isEmpty),a.slot!==this.slot||a.isEmpty||(log.info("ads.rendered-"+this.id),$(document).trigger("ads.rendered-"+this.id))}.bind(this)),this.slot.addService(b),a.collapseEmpty&&this.slot.setCollapseEmptyDiv(!0,!0),this.refresh=a.refresh===!1?!1:!0,GPT.SFP&&"mobile"===a.platform&&this.slot.setTargeting("strnativekey",GPT.SFP),this.slot.setTargeting("pos",a.pos),window.xp1_auds&&window.xp1_auds.Nodes?this.slot.setTargeting("demographics",window.xp1_auds.Nodes.join(",")):window.GPT.demographics&&this.slot.setTargeting("demographics",window.GPT.demographics),GPT.SITE&&this.slot.setTargeting("site",GPT.SITE),GPT.cats&&this.slot.setTargeting("cat",GPT.cats),GPT.tag&&this.slot.setTargeting("tag",GPT.tag),GPT.type&&this.slot.setTargeting("type",GPT.type),GPT.specials&&this.slot.setTargeting("special",GPT.specials),GPT.slug&&this.slot.setTargeting("slug",GPT.slug),GPT.contenttype&&this.slot.setTargeting("contenttype",GPT.contenttype),GPT.contest&&this.slot.setTargeting("contest",GPT.contest),GPT.camera&&this.slot.setTargeting("camera",GPT.camera),GPT.awards&&this.slot.setTargeting("awards",GPT.awards),GPT.referrer&&this.slot.setTargeting("referrer",GPT.referrer),this.slot.setTargeting("initialSessionPage",GPT.initialSessionPage),this}}),AdsAppView=Backbone.View.extend({video:!1,activeAds:[],actionCount:0,settings:[{name:"desktopMain",sizes:[[728,90],[970,90],[970,250]],pos:["top"],collapseEmpty:!1,refresh:!1,platform:"desktop",loading:"instant"},{name:"desktopSideTop",sizes:[[300,1050],[300,600],[300,250]],pos:["top"],collapseEmpty:!1,refresh:!0,platform:"desktop",loading:"lazy"},{name:"desktopSideHouseTop",sizes:[[300,250],[300,200]],pos:["house-top"],collapseEmpty:!0,refresh:!1,platform:"desktop",loading:"lazy"},{name:"desktopSideHouseBottom",sizes:[[300,250],[300,200]],pos:["house-bottom"],collapseEmpty:!0,refresh:!1,platform:"desktop",loading:"lazy"},{name:"desktopSideBottom",sizes:[[300,1050],[300,600],[300,250]],pos:["bottom"],collapseEmpty:!1,refresh:!0,platform:"desktop",loading:"lazy"},{name:"desktopInArticle",sizes:[[728,90],[300,250],[447,140]],pos:["inarticle"],collapseEmpty:!1,refresh:!0,platform:"desktop",loading:"lazy"},{name:"desktopInArticle-0",sizes:[[728,90],[300,250],[447,140]],pos:["inarticle-0"],collapseEmpty:!1,refresh:!1,platform:"desktop",loading:"lazy"},{name:"mobileMain",sizes:[[300,250],[300,50],[320,50],[320,100]],pos:["mobile-top"],collapseEmpty:!1,refresh:!0,platform:"mobile",loading:"instant"},{name:"mobileSharethrough",sizes:[[5,5]],pos:["sharethrough"],collapseEmpty:!0,refresh:!1,platform:"mobile",loading:"instant"},{name:"mobileBottom",sizes:[[300,50],[320,50]],pos:["mobile-bottom"],collapseEmpty:!1,refresh:!0,platform:"mobile",loading:"instant"},{name:"mobileInArticle",sizes:[[300,250]],pos:["mobile-inarticle"],collapseEmpty:!1,refresh:!0,platform:"mobile",loading:"lazy"},{name:"mobileInArticle-0",sizes:[[300,250]],pos:["mobile-inarticle-0"],collapseEmpty:!1,refresh:!1,platform:"mobile",loading:"lazy"}],initialize:function(a){_.bindAll(this,"adsViewportRefresh","visibilityChange","scrollSetup","adSlotSetup","getSettings","contentLoaded"),a=a?a:{},this.video=a.video?!0:!1,this.disableAd=a.disableAd?a.disableAd:null,_.each(a.ads,function(a,b){var c=this.getSettings(a.name);c&&_.extend(c,a.attrs)},this),this.setup(),a.mobileInArticleAds?this.mobileInArticleAds=a.mobileInArticleAds:this.mobileInArticleAds=[2,5,8,11,14,17,20,23,26,29,32,35,38,41,44,47,50],a.desktopInArticleAds?this.desktopInArticleAds=a.desktopInArticleAds:this.desktopInArticleAds=[4,9,14,19,24,29,34,39,44,49],$(document).on("slideshow:change",this.adsViewportRefresh),$(document).on("essay:change",this.adsViewportRefresh),this.setupRefresh(),document.visibilityState?document.addEventListener("visibilitychange",this.visibilityChange):document.webkitVisibilityState?document.addEventListener("webkitvisibilitychange",this.visibilityChange):document.mozVisibilityState?document.addEventListener("mozvisibilitychange",this.visibilityChange):document.msVisibilityState&&document.addEventListener("msvisibilitychange",this.visibilityChange),document.addEventListener("DOMContentLoaded",this.contentLoaded),this.scrollSetup(),this.debouncedScroll=_.debounce(this.scrollSetup,50),$(window).on("scroll",this.debouncedScroll)},isMobile:function(){return window.innerWidth<816},getSettings:function(a){return _.find(this.settings,function(b){return a===b.name})},setup:function(){var a=this;googletag.cmd.push(function(){a.video&&googletag.companionAds().setRefreshUnfilledSlots(!0),googletag.pubads().setTargeting("Site",[window.GPT_SITE]),a.lat&&a.lng&&googletag.pubads().setLocation(latitude,longitude),googletag.enableServices()})},scrollSetup:function(){log.info("scrollSetup");var a=this,b=$(".ad-slot:not([data-ad-setup=true])"),c=b.filter(function(b,c){log.warn(c);var d=$(c),e=d.attr("id"),f=d.data("ad-settings");if(!f||a.disableAd&&-1!==a.disableAd.indexOf(f))return!1;var g=_.extend({id:e},a.getSettings(f));return"mobile"!==g.platform||this.isMobile()?"desktop"===g.platform&&this.isMobile()?(log.warn("Ad desktop only, but mobile window:",e),!1):"instant"===g.loading||a.inViewport(d)?!0:!1:(log.warn("Ad mobile only, but desktop window:",e),!1)}.bind(this));return b.length?void(c.length&&(log.info("AdsAppView.scrollSetup",c.length),googletag.cmd.push(function(){c.each(a.adSlotSetup)}))):void $(window).off("scroll",this.debouncedScroll)},adSlotSetup:function(a,b){var c=$(b),d=c.attr("id"),e=c.data("ad-settings");if(!e)return!1;var f=_.extend({id:d},this.getSettings(e)),g=new AdView(f);log.info("Ad successful setup: ",g.id),this.activeAds.push(g),googletag.display(g.id),$(document).trigger("ads.setup-"+g.id,g)},setupRefresh:function(){this.refreshId=window.setInterval(this.adsViewportRefresh,3e4)},getVisibilityState:function(){return document.visibilityState||document.webkitVisibilityState||document.mozVisibilityState||document.msVisibilityState},visibilityChange:function(){log.debug("visibilityChange",document.visibilityState),"visible"!==this.getVisibilityState()||this.refreshId?"hidden"===this.getVisibilityState()&&this.refreshId&&(this.refreshId=window.clearInterval(this.refreshId)):this.setupRefresh()},getSlots:function(a){var b=[];return _.each(a?a:this.activeAds,function(a,c){a.refresh&&b.push(a.slot)},this),b},inViewport:function(a){log.info("inViewport",a);var b=$(a),c=b.offset(),d={offsetTop:c?c.top:0,height:b.height()},e=$(window).scrollTop(),f=d.offsetTop>=e-d.height/2.25&&d.offsetTop<e+window.innerHeight-d.height/2.25;return f},adsViewportRefresh:function(){var a=this,b=_.filter(this.activeAds,function(b,c){return a.inViewport(b.el)&&b.refresh});log.info("adsViewportRefresh",b);var c=this.getSlots(b);googletag.pubads&&c.length&&googletag.pubads().refresh(c)},contentLoaded:function(){var a,b=$(".article-body"),c=b.children("p"),d=this.isMobile()?"mobileInArticle-":"desktopInArticle-",e=this.isMobile()?"mobileInArticle":"desktopInArticle",f=this.isMobile()?this.mobileInArticleAds:this.desktopInArticleAds;_.isArray(f)||(f=_.range(f,c.length,f)),b.length&&_.each(f,function(b,f){var g=e;log.info("in-article adSettings",g,f),this.getSettings(d+f)&&(g=d+f,log.info("in-article adSettings-X override",g)),b>=c.length||(a=$('<div id="'+d+f+'" class="ad-slot" data-ad-settings="'+g+'"></div>'),this.isMobile()?a.addClass("article-slot-centered hidden-desktop"):a.addClass("article-slot-centered hidden-phone"),$(c[b]).before(a))},this)}});